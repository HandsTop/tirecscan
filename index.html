<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tires</title>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body{margin:0;background:#0e1016;color:#e6e6e6;font-family:-apple-system,system-ui,Arial;}
    header{padding:12px 14px;background:#12141a;border-bottom:1px solid #222;position:sticky;top:0;z-index:10;}
    main{padding:0;display:block;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .col{flex:1;min-width:0;}
    .muted{font-size:13px;opacity:.8;margin-top:8px;line-height:1.35;}
    .small{font-size:13px;opacity:.9;line-height:1.35;}

    .card{background:#12141a;border:1px solid #23262f;border-radius:14px;padding:14px;}
    label{font-size:12px;opacity:.85;display:block;margin-top:10px;}

    input,select,button{
      width:100%;box-sizing:border-box;padding:12px;margin-top:6px;
      border-radius:10px;border:1px solid #2a2f3a;background:#0e1016;color:#fff;font-size:16px;
    }
    button{border:none;border-radius:12px;}
    button:disabled{opacity:.45;}
    .primary{background:#1b3cff;}
    .danger{background:#5a1a1a;}
    .ghost{background:#0e1016;border:1px solid #2a2f3a;}
    #reader{width:100%;border-radius:14px;overflow:hidden;background:#000;border:1px solid #23262f;margin-top:12px;}

    .toolbar{display:grid;gap:10px;margin-top:10px;}
    .item{border:1px solid #2a2f3a;border-radius:12px;padding:10px;margin-top:10px;background:#0e1016;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2a2f3a;background:#12141a;font-size:12px;opacity:.95;margin-right:6px;margin-top:6px;}

    details.group{border:1px solid #23262f;border-radius:12px;background:#0e1016;margin-top:10px;overflow:hidden;}
    details.group>summary{cursor:pointer;list-style:none;padding:10px 12px;font-weight:650;background:#12141a;border-bottom:1px solid #23262f;}
    details.group>summary::-webkit-details-marker{display:none;}
    .groupBody{padding:10px 12px;}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:9999;padding:16px;}
    .modal{width:min(860px,100%);max-height:85vh;overflow:auto;background:#12141a;border:1px solid #23262f;border-radius:16px;padding:14px;}
    .modalTop{display:flex;gap:10px;align-items:center;}
    .modalTop b{flex:1;min-width:0;}
    .modalClose{width:auto;margin-top:0;padding:10px 12px;border-radius:12px;background:#0e1016;border:1px solid #2a2f3a;color:#fff;}
    .histItem{border:1px solid #23262f;border-radius:12px;padding:10px;margin-top:10px;background:#0e1016;}
    .histMeta{font-size:13px;opacity:.9;}
    .histLine{margin-top:6px;font-size:13px;line-height:1.35;}

    /* Home */
    main{padding:0;display:block;}
    .homeFull{width:100%;height:calc(100vh - 58px);display:flex;align-items:center;justify-content:center;background:#0e1016;}
    .homeLogo{width:90%;height:90%;object-fit:contain;display:block;}

    /* Menu */
    .menuBtn{
      width:auto;margin-top:0;padding:10px 12px;border-radius:12px;
      background:#0e1016;border:1px solid #2a2f3a;color:#fff;
      font-size:18px;line-height:1;
    }
    .menuBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9998;}
    .menuPanel{
      position:fixed;top:10px;left:10px;z-index:9999;
      width:260px;max-width:80vw;
      background:#12141a;border:1px solid #23262f;border-radius:14px;
      padding:10px;
      display:none;
    }
    .menuItem{
      width:100%;text-align:left;padding:12px;border-radius:12px;
      border:1px solid #2a2f3a;background:#0e1016;color:#fff;
      margin-top:8px;
    }
    .menuItem.active{border-color:#1b3cff;}
    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  </style>
</head>

<body>
<header>
  <div class="row">
    <button id="menuBtn" class="menuBtn" aria-label="menu">☰</button>
    <div class="col" style="min-width:180px;">
      <b id="uiTitle">Tires</b>
      <div class="muted" id="pageSubtitle" style="margin-top:4px;"></div>
    </div>

    <div class="topRight">
      <select id="lang" style="width:auto;min-width:120px;margin-top:0;">
        <option value="ru">RU</option>
        <option value="de">DE</option>
        <option value="lv">LV</option>
      </select>

      <input id="username" style="width:auto;min-width:180px;margin-top:0;" />
      <button id="confirmUser" class="primary" style="width:auto;margin-top:0;padding:10px 12px;"></button>
    </div>
  </div>

  <div class="muted" id="userHint"></div>
</header>

<!-- Menu overlay -->
<div id="menuBack" class="menuBack"></div>
<div id="menuPanel" class="menuPanel" role="menu">
  <button id="menuHome" class="menuItem"></button>
  <button id="menuScan" class="menuItem"></button>
</div>

<main>

  <!-- HOME PAGE -->
<section id="pageHome" class="homeFull" style="display:none;">
  <img class="homeLogo" src="logo.png" alt="Logo">
</section>

  <!-- SCAN PAGE -->
  <div id="pageScan" style="display:none; display:grid; gap:14px;">

    <!-- Scanner (ADMIN ONLY) -->
    <section id="scannerCard" class="card" style="display:none;">
      <div class="row" style="align-items:flex-start;">
        <div class="col"><button id="start" class="primary" style="margin-top:0;"></button></div>
        <div class="col"><button id="stop" class="danger" style="margin-top:0;" disabled></button></div>
      </div>

      <div id="reader"></div>
      <div class="muted" id="status"></div>
      <div class="muted" id="scanHint"></div>
    </section>

    <!-- Form (ADMIN ONLY) -->
    <section id="formCard" class="card" style="display:none;">
      <label id="lblEan"></label>
      <input id="ean" inputmode="numeric" />

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label id="lblMaker" style="margin-top:0;"></label>
          <input id="maker" />
        </div>
        <div class="col">
          <label id="lblTireModel" style="margin-top:0;"></label>
          <input id="tireModel" />
        </div>
      </div>

      <label id="lblSize"></label>
      <input id="size" />

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label id="lblLoc" style="margin-top:0;"></label>
          <input id="loc" />
        </div>
        <div class="col">
          <label id="lblQty" style="margin-top:0;"></label>
          <input id="qty" type="number" min="0" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col"><button id="save" class="primary" style="margin-top:0;"></button></div>
        <div class="col"><button id="clear" class="ghost" style="margin-top:0;"></button></div>
      </div>

      <div class="muted" id="rightsHint"></div>
    </section>

    <!-- List (ALL USERS) -->
    <section class="card">
      <div class="row" style="align-items:center;">
        <div class="col"><b id="listTitle"></b></div>
        <div class="col">
          <button id="openGlobalHistory" class="ghost" style="margin-top:0;"></button>
        </div>
      </div>

      <div class="toolbar">
        <input id="search" />

        <div class="row">
          <div class="col">
            <label id="lblGroup" style="margin-top:0;"></label>
            <select id="groupBy">
              <option value="location"></option>
              <option value="maker"></option>
              <option value="none"></option>
            </select>
          </div>

          <div class="col">
            <label id="lblSort" style="margin-top:0;"></label>
            <select id="sortBy">
              <option value="updated_desc"></option>
              <option value="updated_asc"></option>
              <option value="qty_desc"></option>
              <option value="loc_asc"></option>
              <option value="maker_asc"></option>
              <option value="model_asc"></option>
            </select>
          </div>
        </div>
      </div>

      <div class="muted" id="stats" style="margin-top:10px;"></div>
      <div id="list"></div>
    </section>

  </div>
</main>

<!-- Modal -->
<div id="modalBack" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalTop">
      <b id="modalTitle"></b>
      <button id="modalClose" class="modalClose"></button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* ==============================
   Config / storage
============================== */
const ADMIN_NAME = "Andrejs O";
const STORAGE = {
  lang: "tires_lang_v5",
  user: "tires_user_fixed_v5",
  page: "tires_page_v1",
  db:   "tires_db_v8",
  gh:   "tires_global_history_v4",
};

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw);
  } catch { return fallback; }
}
function saveJSON(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

/* ==============================
   i18n
============================== */
const I18N = {
  ru: {
    title: "Учёт шин",
    home: "Дом",
    scan: "Сканирование",

    pageHome: "Главная",
    pageScan: "Сканирование",

    userPh: "Имя пользователя",
    confirm: "Подтвердить",
    userNeed: "Сначала введи имя пользователя.",
    userLocked: "Имя закреплено за этим устройством.",
    rightsAdmin: "Права: админ (добавление/редактирование/удаление).",
    rightsUser: "Права: просмотр (история доступна).",

    start: "Включить камеру",
    stop: "Выключить",
    camOff: "Камера выключена",
    camOn: "Камера включена. Наведи на штрих-код…",
    found: "Найдено",
    autoOff: "(камера выключается)",
    scanHint: "После успешного скана камера выключится, форма очистится (кроме EAN).",

    ean: "Штрих-код (EAN)",
    eanPh: "сканируется автоматически",
    maker: "Марка",
    makerPh: "например Nexen",
    tireModel: "Модель",
    tireModelPh: "например WinGuard WT1",
    size: "Размер",
    sizePh: "например 195/65 R16 104/102T",
    loc: "Локация",
    locPh: "например 216",
    qty: "Кол-во",
    qtyPh: "например 34",

    save: "Сохранить",
    clear: "Очистить",

    listTitle: "Список шин",
    openGlobalHistory: "Общая история",
    searchPh: "Поиск: EAN, марка, модель, размер, локация",

    group: "Группировка",
    sort: "Сортировка",
    groupLoc: "По локации",
    groupMaker: "По марке",
    groupNone: "Без группировки",

    sortNew: "Сначала новые",
    sortOld: "Сначала старые",
    sortQty: "Кол-во ↓",
    sortLoc: "Локация A→Z",
    sortMaker: "Марка A→Z",
    sortModel: "Модель A→Z",

    total: "Всего записей",
    shown: "Показано",
    nothing: "Ничего не найдено.",
    promptSearch: "Введите поиск или отсканируйте штрих-код.",
    all: "Все",
    noLoc: "Без локации",
    noMaker: "Без марки",

    hist: "История",
    del: "Удалить",
    open: "Открыть",

    delConfirm: "Удалить запись?",
    noEan: "Нет EAN (штрих-кода).",
    badQty: "Кол-во должно быть числом (0 или больше).",
    needHttps: "Нужно HTTPS (GitHub Pages). Открой страницу по ссылке https://...",
    camFail: "Не удалось включить камеру. Проверь разрешение: Настройки → Safari → Камера.",
    cantEdit: "Доступ запрещён (только Andrejs O).",

    histTitleItem: "История позиции",
    histTitleGlobal: "Общая история действий",
    close: "Закрыть",
    created: "Создано",
    updated: "Изменено",
    deleted: "Удалено",
    field: { maker:"Марка", tireModel:"Модель", size:"Размер", loc:"Локация", qty:"Кол-во" }
  },

  de: {
    title: "Reifenverwaltung",
    home: "Start",
    scan: "Scannen",

    pageHome: "Startseite",
    pageScan: "Scannen",

    userPh: "Benutzername",
    confirm: "Bestätigen",
    userNeed: "Bitte zuerst einen Benutzernamen eingeben.",
    userLocked: "Name ist an dieses Gerät gebunden.",
    rightsAdmin: "Rolle: Admin (Anlegen/Bearbeiten/Löschen).",
    rightsUser: "Rolle: Ansicht (Verlauf verfügbar).",

    start: "Kamera starten",
    stop: "Stop",
    camOff: "Kamera aus",
    camOn: "Kamera an. Auf den Barcode richten…",
    found: "Gefunden",
    autoOff: "(Kamera wird beendet)",
    scanHint: "Nach einem erfolgreichen Scan wird die Kamera beendet und das Formular geleert (EAN bleibt).",

    ean: "Barcode (EAN)",
    eanPh: "wird automatisch gescannt",
    maker: "Hersteller",
    makerPh: "z. B. Nexen",
    tireModel: "Modell",
    tireModelPh: "z. B. WinGuard WT1",
    size: "Größe",
    sizePh: "z. B. 195/65 R16 104/102T",
    loc: "Lagerplatz",
    locPh: "z. B. 216",
    qty: "Menge",
    qtyPh: "z. B. 34",

    save: "Speichern",
    clear: "Leeren",

    listTitle: "Reifenliste",
    openGlobalHistory: "Globaler Verlauf",
    searchPh: "Suche: EAN, Hersteller, Modell, Größe, Lagerplatz",

    group: "Gruppierung",
    sort: "Sortierung",
    groupLoc: "Nach Lagerplatz",
    groupMaker: "Nach Hersteller",
    groupNone: "Keine Gruppierung",

    sortNew: "Neueste zuerst",
    sortOld: "Älteste zuerst",
    sortQty: "Menge ↓",
    sortLoc: "Lagerplatz A→Z",
    sortMaker: "Hersteller A→Z",
    sortModel: "Modell A→Z",

    total: "Einträge gesamt",
    shown: "Angezeigt",
    nothing: "Keine Treffer.",
    promptSearch: "Bitte suchen oder Barcode scannen.",
    all: "Alle",
    noLoc: "Ohne Lagerplatz",
    noMaker: "Ohne Hersteller",

    hist: "Verlauf",
    del: "Löschen",
    open: "Öffnen",

    delConfirm: "Eintrag löschen?",
    noEan: "EAN fehlt.",
    badQty: "Menge muss eine Zahl sein (0 oder mehr).",
    needHttps: "HTTPS erforderlich (GitHub Pages). Öffne die Seite über https://…",
    camFail: "Kamera konnte nicht gestartet werden. Prüfe: Einstellungen → Safari → Kamera.",
    cantEdit: "Nicht erlaubt (nur Andrejs O).",

    histTitleItem: "Eintragsverlauf",
    histTitleGlobal: "Globaler Aktionsverlauf",
    close: "Schließen",
    created: "Erstellt",
    updated: "Geändert",
    deleted: "Gelöscht",
    field: { maker:"Hersteller", tireModel:"Modell", size:"Größe", loc:"Lagerplatz", qty:"Menge" }
  },

  lv: {
    title: "Riepu uzskaite",
    home: "Sākums",
    scan: "Skenēšana",

    pageHome: "Sākumlapa",
    pageScan: "Skenēšana",

    userPh: "Lietotājvārds",
    confirm: "Apstiprināt",
    userNeed: "Vispirms ievadi lietotājvārdu.",
    userLocked: "Vārds piesaistīts šai ierīcei.",
    rightsAdmin: "Loma: Admin (pievienot/labot/dzēst).",
    rightsUser: "Loma: Skatīšana (vēsture pieejama).",

    start: "Ieslēgt kameru",
    stop: "Izslēgt",
    camOff: "Kamera izslēgta",
    camOn: "Kamera ieslēgta. Tēmē uz svītrkodu…",
    found: "Atrasts",
    autoOff: "(kamera izslēdzas)",
    scanHint: "Pēc veiksmīga skenējuma kamera izslēdzas un forma tiek notīrīta (EAN paliek).",

    ean: "Svītrkods (EAN)",
    eanPh: "tiek noskenēts automātiski",
    maker: "Ražotājs",
    makerPh: "piem. Nexen",
    tireModel: "Modelis",
    tireModelPh: "piem. WinGuard WT1",
    size: "Izmērs",
    sizePh: "piem. 195/65 R16 104/102T",
    loc: "Vieta",
    locPh: "piem. 216",
    qty: "Daudzums",
    qtyPh: "piem. 34",

    save: "Saglabāt",
    clear: "Notīrīt",

    listTitle: "Riepu saraksts",
    openGlobalHistory: "Kopējā vēsture",
    searchPh: "Meklēšana: EAN, ražotājs, modelis, izmērs, vieta",

    group: "Grupēšana",
    sort: "Kārtošana",
    groupLoc: "Pēc vietas",
    groupMaker: "Pēc ražotāja",
    groupNone: "Bez grupēšanas",

    sortNew: "Jaunākie vispirms",
    sortOld: "Vecākie vispirms",
    sortQty: "Daudzums ↓",
    sortLoc: "Vieta A→Z",
    sortMaker: "Ražotājs A→Z",
    sortModel: "Modelis A→Z",

    total: "Kopā ieraksti",
    shown: "Parādīts",
    nothing: "Nav rezultātu.",
    promptSearch: "Lūdzu, meklē vai noskenē svītrkodu.",
    all: "Visi",
    noLoc: "Bez vietas",
    noMaker: "Bez ražotāja",

    hist: "Vēsture",
    del: "Dzēst",
    open: "Atvērt",

    delConfirm: "Dzēst ierakstu?",
    noEan: "Trūkst EAN.",
    badQty: "Daudzumam jābūt skaitlim (0 vai vairāk).",
    needHttps: "Nepieciešams HTTPS (GitHub Pages). Atver lapu ar https://…",
    camFail: "Neizdevās ieslēgt kameru. Pārbaudi: Iestatījumi → Safari → Kamera.",
    cantEdit: "Nav atļauts (tikai Andrejs O).",

    histTitleItem: "Ieraksta vēsture",
    histTitleGlobal: "Kopējā darbību vēsture",
    close: "Aizvērt",
    created: "Izveidots",
    updated: "Mainīts",
    deleted: "Dzēsts",
    field: { maker:"Ražotājs", tireModel:"Modelis", size:"Izmērs", loc:"Vieta", qty:"Daudzums" }
  }
};

/* ==============================
   State
============================== */
let lang = loadJSON(STORAGE.lang, "ru");
if (!I18N[lang]) lang = "ru";

let user = loadJSON(STORAGE.user, "");
let page = loadJSON(STORAGE.page, "home"); // "home" | "scan"

let db = loadJSON(STORAGE.db, []);
let globalHistory = loadJSON(STORAGE.gh, []);

let scanner = null;
let scanning = false;
let lastScan = "";

/* ==============================
   DOM
============================== */
const $ = (id) => document.getElementById(id);
const el = {
  uiTitle: $("uiTitle"),
  pageSubtitle: $("pageSubtitle"),
  lang: $("lang"),
  username: $("username"),
  confirmUser: $("confirmUser"),
  userHint: $("userHint"),

  // menu
  menuBtn: $("menuBtn"),
  menuBack: $("menuBack"),
  menuPanel: $("menuPanel"),
  menuHome: $("menuHome"),
  menuScan: $("menuScan"),

  // pages
  pageHome: $("pageHome"),
  pageScan: $("pageScan"),
  scannerCard: $("scannerCard"),
  formCard: $("formCard"),

  // scanner/form
  start: $("start"),
  stop: $("stop"),
  reader: $("reader"),
  status: $("status"),
  scanHint: $("scanHint"),

  lblEan: $("lblEan"),
  ean: $("ean"),
  lblMaker: $("lblMaker"),
  maker: $("maker"),
  lblTireModel: $("lblTireModel"),
  tireModel: $("tireModel"),
  lblSize: $("lblSize"),
  size: $("size"),
  lblLoc: $("lblLoc"),
  loc: $("loc"),
  lblQty: $("lblQty"),
  qty: $("qty"),
  save: $("save"),
  clear: $("clear"),
  rightsHint: $("rightsHint"),

  // list
  listTitle: $("listTitle"),
  openGlobalHistory: $("openGlobalHistory"),
  search: $("search"),
  lblGroup: $("lblGroup"),
  groupBy: $("groupBy"),
  lblSort: $("lblSort"),
  sortBy: $("sortBy"),
  stats: $("stats"),
  list: $("list"),

  // modal
  modalBack: $("modalBack"),
  modalTitle: $("modalTitle"),
  modalBody: $("modalBody"),
  modalClose: $("modalClose"),
};

function T(){ return I18N[lang]; }
function isAdmin(){ return user === ADMIN_NAME; }
function now(){ return Date.now(); }
function normEAN(x){ return String(x||"").replace(/\s+/g,"").trim(); }
function normText(x){ return String(x||"").trim(); }

function ensureUser(){
  if (user) return true;
  alert(T().userNeed);
  return false;
}

/* ==============================
   Visibility (важно: скрываем недоступное)
============================== */
function applyAccessVisibility(){
  const admin = isAdmin();

  // Камера доступна всем (для поиска)
  if (el.scannerCard) el.scannerCard.style.display = "";

  // Форма добавления/редактирования — только админ
  if (el.formCard) el.formCard.style.display = admin ? "" : "none";

  // Общая история — только админ (и защита от null)
  if (el.openGlobalHistory) el.openGlobalHistory.style.display = admin ? "" : "none";
}

/* ==============================
   Pages / Menu
============================== */
function setPage(next){
  page = next;
  saveJSON(STORAGE.page, page);

  const t = T();
  el.pageHome.style.display = (page === "home") ? "" : "none";
  el.pageScan.style.display = (page === "scan") ? "grid" : "none";
  el.pageSubtitle.textContent = (page === "home") ? t.pageHome : t.pageScan;

  // menu active
  el.menuHome.classList.toggle("active", page === "home");
  el.menuScan.classList.toggle("active", page === "scan");

  closeMenu();

  // если ушли со страницы сканирования — выключаем камеру
  if (page !== "scan") stopCamera().catch(()=>{});
}

function openMenu(){
  el.menuBack.style.display = "block";
  el.menuPanel.style.display = "block";
}
function closeMenu(){
  el.menuBack.style.display = "none";
  el.menuPanel.style.display = "none";
}

/* ==============================
   i18n apply
============================== */
function applyI18n(){
  const t = T();

  el.uiTitle.textContent = t.title;

  // menu labels
  el.menuHome.textContent = t.home;
  el.menuScan.textContent = t.scan;

  // user
  el.username.placeholder = t.userPh;
  el.confirmUser.textContent = t.confirm;
  el.userHint.textContent = user ? t.userLocked : t.userNeed;

  // scanner
  el.start.textContent = t.start;
  el.stop.textContent = t.stop;
  el.status.textContent = scanning ? t.camOn : t.camOff;
  el.scanHint.textContent = t.scanHint;

  // form
  el.lblEan.textContent = t.ean; el.ean.placeholder = t.eanPh;
  el.lblMaker.textContent = t.maker; el.maker.placeholder = t.makerPh;
  el.lblTireModel.textContent = t.tireModel; el.tireModel.placeholder = t.tireModelPh;
  el.lblSize.textContent = t.size; el.size.placeholder = t.sizePh;
  el.lblLoc.textContent = t.loc; el.loc.placeholder = t.locPh;
  el.lblQty.textContent = t.qty; el.qty.placeholder = t.qtyPh;

  el.save.textContent = t.save;
  el.clear.textContent = t.clear;

  el.rightsHint.textContent = user ? (isAdmin() ? t.rightsAdmin : t.rightsUser) : "";

  // list
  el.listTitle.textContent = t.listTitle;
  el.openGlobalHistory.textContent = t.openGlobalHistory;
  el.search.placeholder = t.searchPh;

  el.lblGroup.textContent = t.group;
  el.lblSort.textContent = t.sort;

  el.groupBy.options[0].text = t.groupLoc;
  el.groupBy.options[1].text = t.groupMaker;
  el.groupBy.options[2].text = t.groupNone;

  el.sortBy.options[0].text = t.sortNew;
  el.sortBy.options[1].text = t.sortOld;
  el.sortBy.options[2].text = t.sortQty;
  el.sortBy.options[3].text = t.sortLoc;
  el.sortBy.options[4].text = t.sortMaker;
  el.sortBy.options[5].text = t.sortModel;

  // modal
  el.modalClose.textContent = t.close;

  // page subtitle
  el.pageSubtitle.textContent = (page === "home") ? t.pageHome : t.pageScan;
}

/* ==============================
   History helpers
============================== */
function diffItem(prev, next){
  const fields = ["maker","tireModel","size","loc","qty"];
  const changes = [];
  for (const f of fields) {
    const a = (f==="qty") ? Number(prev[f] ?? 0) : String(prev[f]||"");
    const b = (f==="qty") ? Number(next[f] ?? 0) : String(next[f]||"");
    if (String(a) !== String(b)) changes.push({ field:f, from:a, to:b });
  }
  return changes;
}
function pushGlobalHistory(action, ean, changes){
  globalHistory.unshift({ ts: now(), user, action, ean, changes: changes || [] });
  if (globalHistory.length > 500) globalHistory.length = 500;
  saveJSON(STORAGE.gh, globalHistory);
}

/* ==============================
   Modal
============================== */
function openModal(title, html){
  el.modalTitle.textContent = title;
  el.modalBody.innerHTML = html;
  el.modalBack.style.display = "flex";
}
function closeModal(){
  el.modalBack.style.display = "none";
  el.modalBody.innerHTML = "";
}
function renderHistoryEntries(entries, labelFn){
  if (!entries.length) return `<div class="muted">${T().nothing}</div>`;
  return entries.map(h => {
    const ts = new Date(h.ts || now()).toLocaleString();
    const label = labelFn(h);
    const lines = (h.changes && h.changes.length)
      ? h.changes.map(c => {
          const name = (T().field && T().field[c.field]) ? T().field[c.field] : c.field;
          return `<div class="histLine">${name}: ${c.from} → ${c.to}</div>`;
        }).join("")
      : `<div class="histLine">—</div>`;
    return `<div class="histItem"><div class="histMeta">${ts} • ${h.user || "—"} • ${label}</div>${lines}</div>`;
  }).join("");
}

function showItemHistory(ean){
  const it = db.find(x => x.ean === ean);
  const entries = (it && Array.isArray(it.history)) ? it.history : [];
  const html = renderHistoryEntries(entries, (h) => (h.type === "create") ? T().created : T().updated);
  openModal(`${T().histTitleItem}: ${ean}`, html);
}

function showGlobalHistory(){
  if (!isAdmin()) return;
  const entries = Array.isArray(globalHistory) ? globalHistory : [];
  const html = renderHistoryEntries(entries, (h) => {
    if (h.action === "create") return T().created;
    if (h.action === "delete") return T().deleted;
    return T().updated;
  }).replaceAll(`<div class="histLine">—</div>`, "");
  openModal(T().histTitleGlobal, html || `<div class="muted">${T().nothing}</div>`);
}

/* ==============================
   Camera (ADMIN ONLY actions)
============================== */
function clearForm({ keepEAN=false } = {}){
  const keep = el.ean.value;
  el.ean.value = keepEAN ? keep : "";
  el.maker.value = "";
  el.tireModel.value = "";
  el.size.value = "";
  el.loc.value = "";
  el.qty.value = "";
}

async function stopCamera(){
  if (scanner && scanning) {
    try { await scanner.stop(); } catch {}
    try { await scanner.clear(); } catch {}
  }
  scanner = null;
  scanning = false;
  el.start.disabled = false;
  el.stop.disabled = true;
  el.status.textContent = T().camOff;
}

async function startCamera(){
async (text) => {
  const v = normEAN(text);
  if (!v || v === lastScan) return;
  lastScan = v;

  if (isAdmin()) {
    // Админ: заполняем форму
    el.ean.value = v;
    el.maker.value = "";
    el.tireModel.value = "";
    el.size.value = "";
    el.loc.value = "";
    el.qty.value = "";

    el.status.textContent = `${T().found}: ${v} ${T().autoOff}`;
    await stopCamera();
    el.maker.focus();
  } else {
    // Обычный пользователь: это ПОИСК
    el.search.value = v;
    renderList();

    el.status.textContent = `${T().found}: ${v} ${T().autoOff}`;
    await stopCamera();
    el.list.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}

/* ==============================
   Admin-only save / delete / open
============================== */
function upsertItemFromForm(){
  if (!ensureUser()) return;
  if (!isAdmin()) { alert(T().cantEdit); return; } // только админ может добавлять/редактировать

  const ean = normEAN(el.ean.value);
  if (!ean) { alert(T().noEan); return; }

  const qty = Number(el.qty.value || 0);
  if (!Number.isFinite(qty) || qty < 0) { alert(T().badQty); return; }

  const next = {
    ean,
    maker: normText(el.maker.value),
    tireModel: normText(el.tireModel.value),
    size: normText(el.size.value),
    loc: normText(el.loc.value),
    qty,
    createdAt: now(),
    updatedAt: now(),
    history: []
  };

  const idx = db.findIndex(x => x.ean === ean);

  if (idx >= 0) {
    const prev = db[idx];
    next.createdAt = prev.createdAt || next.createdAt;
    next.history = Array.isArray(prev.history) ? prev.history : [];
    const changes = diffItem(prev, next);

    if (changes.length) {
      next.history.unshift({ type:"update", user, ts: now(), changes });
      pushGlobalHistory("update", ean, changes);
    }
    db[idx] = next;
  } else {
    next.history = [{ type:"create", user, ts: now(), changes: [] }];
    pushGlobalHistory("create", ean, []);
    db.push(next);
  }

  saveJSON(STORAGE.db, db);
  renderList();
  clearForm({ keepEAN:false });
  el.ean.focus();
}

function deleteItem(ean){
  if (!ensureUser()) return;
  if (!isAdmin()) { alert(T().cantEdit); return; }
  if (!confirm(T().delConfirm)) return;

  db = db.filter(x => x.ean !== ean);
  saveJSON(STORAGE.db, db);
  pushGlobalHistory("delete", ean, []);
  renderList();
}

function fillFormFromItem(it){
  // только админ вообще видит кнопку "Открыть", поэтому тут без доп. проверок
  el.ean.value = it.ean || "";
  el.maker.value = it.maker || "";
  el.tireModel.value = it.tireModel || "";
  el.size.value = it.size || "";
  el.loc.value = it.loc || "";
  el.qty.value = String(it.qty ?? "");
  window.scrollTo({ top:0, behavior:"smooth" });
}

/* ==============================
   List: filter/sort/group
============================== */
function compareItems(a,b,mode){
  const s = (x)=>String(x||"");
  if (mode==="updated_desc") return (b.updatedAt||0)-(a.updatedAt||0);
  if (mode==="updated_asc")  return (a.updatedAt||0)-(b.updatedAt||0);
  if (mode==="qty_desc")     return (b.qty||0)-(a.qty||0);
  if (mode==="loc_asc")      return s(a.loc).localeCompare(s(b.loc),"ru");
  if (mode==="maker_asc")    return s(a.maker).localeCompare(s(b.maker),"ru");
  if (mode==="model_asc")    return s(a.tireModel).localeCompare(s(b.tireModel),"ru");
  return 0;
}
function filterItems(items){
  const q = normText(el.search.value).toLowerCase();
  if (!q) return []; // пока нет поиска — список пустой

  return items.filter(x =>
    String(x.ean||"").toLowerCase().includes(q) ||
    String(x.maker||"").toLowerCase().includes(q) ||
    String(x.tireModel||"").toLowerCase().includes(q) ||
    String(x.size||"").toLowerCase().includes(q) ||
    String(x.loc||"").toLowerCase().includes(q)
  );
}
function groupItems(items, mode){
  if (mode==="none") return { [T().all]: items };
  const map = new Map();
  for (const it of items) {
    const key = (mode==="maker")
      ? (normText(it.maker) || T().noMaker)
      : (normText(it.loc) || T().noLoc);
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  }
  const keys = Array.from(map.keys()).sort((a,b)=>String(a).localeCompare(String(b),"ru"));
  const out = {};
  for (const k of keys) out[k] = map.get(k);
  return out;
}

function itemCard(it){
  const head = [it.maker, it.tireModel].filter(Boolean).join(" ") || "—";
  const wrap = document.createElement("div");
  wrap.className = "item";

  wrap.innerHTML = `
    <b>${head}</b>
    <div class="small" style="margin-top:6px;">${T().size}: ${it.size ? it.size : "—"}</div>
    <div class="mono" style="margin-top:6px;">${it.ean}</div>
    <div style="margin-top:8px;">
      <span class="badge">${T().loc}: <b>${it.loc || "-"}</b></span>
      <span class="badge">${T().qty}: <b>${Number.isFinite(it.qty) ? it.qty : 0}</b></span>
    </div>
  `;

  const btnRow = document.createElement("div");
  btnRow.className = "row";
  btnRow.style.marginTop = "10px";
  btnRow.style.gap = "8px";

  // История — всем
  const histBtn = document.createElement("button");
  histBtn.className = "ghost";
  histBtn.style.marginTop = "0";
  histBtn.textContent = T().hist;
  histBtn.onclick = () => showItemHistory(it.ean);

  // Админ видит "Открыть" и "Удалить". Остальные вообще не видят эти кнопки.
  if (isAdmin()) {
    const openBtn = document.createElement("button");
    openBtn.className = "primary";
    openBtn.style.marginTop = "0";
    openBtn.textContent = T().open;
    openBtn.onclick = () => fillFormFromItem(it);

    const delBtn = document.createElement("button");
    delBtn.className = "danger";
    delBtn.style.marginTop = "0";
    delBtn.textContent = T().del;
    delBtn.onclick = () => deleteItem(it.ean);

    const c1 = document.createElement("div"); c1.className = "col"; c1.appendChild(openBtn);
    const c2 = document.createElement("div"); c2.className = "col"; c2.appendChild(histBtn);
    const c3 = document.createElement("div"); c3.className = "col"; c3.appendChild(delBtn);
    btnRow.appendChild(c1); btnRow.appendChild(c2); btnRow.appendChild(c3);
  } else {
    // Только одна кнопка "История" (по центру)
    const c = document.createElement("div");
    c.className = "col";
    c.appendChild(histBtn);
    btnRow.appendChild(c);
  }

  wrap.appendChild(btnRow);
  return wrap;
}

function renderList(){
  const filtered = filterItems(db.slice());
  filtered.sort((a,b)=>compareItems(a,b,el.sortBy.value));

  const q = normText(el.search.value);
  el.stats.textContent = `${T().total}: ${db.length}` + (q ? ` • ${T().shown}: ${filtered.length}` : "");

  el.list.innerHTML = "";
  if (!filtered.length) {
  const empty = document.createElement("div");
  empty.className = "muted";
  empty.textContent = normText(el.search.value) ? T().nothing : (T().promptSearch || T().nothing);
  el.list.appendChild(empty);
  return;
}

  const grouped = groupItems(filtered, el.groupBy.value);

  if (el.groupBy.value === "none") {
    const items = grouped[T().all] || filtered;
    for (const it of items) el.list.appendChild(itemCard(it));
    return;
  }

  for (const [gname, items] of Object.entries(grouped)) {
    const det = document.createElement("details");
    det.className = "group";
    det.open = true;

    const sum = document.createElement("summary");
    sum.textContent = `${gname} • ${items.length}`;
    det.appendChild(sum);

    const body = document.createElement("div");
    body.className = "groupBody";
    for (const it of items) body.appendChild(itemCard(it));

    det.appendChild(body);
    el.list.appendChild(det);
  }
}

/* ==============================
   Init / events
============================== */
function initUserUI(){
  el.lang.value = lang;
  if (user) {
    el.username.value = user;
    el.username.disabled = true;
    el.confirmUser.disabled = true;
  } else {
    el.username.value = "";
    el.username.disabled = false;
    el.confirmUser.disabled = false;
  }
}

function bindEvents(){
  // menu
  el.menuBtn.addEventListener("click", openMenu);
  el.menuBack.addEventListener("click", closeMenu);
  el.menuHome.addEventListener("click", () => setPage("home"));
  el.menuScan.addEventListener("click", () => setPage("scan"));

  // lang
  el.lang.addEventListener("change", () => {
    lang = el.lang.value;
    saveJSON(STORAGE.lang, lang);
    applyI18n();
    renderList();
    setPage(page); // обновит подписи меню/подзаголовок
  });

  // user confirm
  el.confirmUser.addEventListener("click", () => {
    const v = normText(el.username.value);
    if (!v) { alert(T().userNeed); return; }
    saveJSON(STORAGE.user, v);
    location.reload();
  });

  // camera (admin-only is enforced inside)
  el.start.addEventListener("click", startCamera);
  el.stop.addEventListener("click", stopCamera);

  // form
  el.clear.addEventListener("click", () => { clearForm({ keepEAN:false }); el.ean.focus(); });
  el.save.addEventListener("click", upsertItemFromForm);

  // list
  el.openGlobalHistory.addEventListener("click", showGlobalHistory);
  el.search.addEventListener("input", renderList);
  el.groupBy.addEventListener("change", renderList);
  el.sortBy.addEventListener("change", renderList);

  // modal
  el.modalClose.addEventListener("click", closeModal);
  el.modalBack.addEventListener("click", (e) => { if (e.target === el.modalBack) closeModal(); });
}

function boot(){
  initUserUI();
  applyI18n();
  applyAccessVisibility();

  // default page: home
  if (page !== "home" && page !== "scan") page = "home";
  setPage(page);

  bindEvents();
  renderList();
}

boot();
</script>
</body>
</html>
