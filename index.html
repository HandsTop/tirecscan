<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Учёт шин — сканер</title>

  <!-- Библиотека сканирования (РАБОТАЕТ В SAFARI iOS) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      margin: 0;
      background: #0e1016;
      color: #e6e6e6;
      font-family: -apple-system, system-ui, Arial;
    }
    header {
      padding: 14px 16px;
      background: #12141a;
      font-weight: 600;
      font-size: 16px;
      border-bottom: 1px solid #222;
    }
    main {
      padding: 16px;
      display: grid;
      gap: 14px;
    }
    .card {
      background: #12141a;
      border: 1px solid #23262f;
      border-radius: 14px;
      padding: 14px;
    }
    label {
      font-size: 12px;
      opacity: .8;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #2a2f3a;
      background: #0e1016;
      color: #fff;
      margin-top: 6px;
    }
    button {
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 15px;
    }
    .primary { background: #1b3cff; color: #fff; }
    .danger { background: #5a1a1a; color: #fff; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #reader {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: black;
    }
    .item {
      border: 1px solid #2a2f3a;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
    }
    .mono {
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>

<body>
<header>Учёт шин — сканер камерой</header>

<main>

  <!-- СКАНЕР -->
  <section class="card">
    <button id="start" class="primary">Включить камеру</button>
    <button id="stop" class="danger" disabled>Выключить</button>
    <div id="reader" style="margin-top:12px;"></div>
    <div id="status" style="margin-top:8px; font-size:13px; opacity:.8;">
      Камера выключена
    </div>
  </section>

  <!-- ФОРМА -->
  <section class="card">
    <label>Штрих-код</label>
    <input id="barcode" placeholder="сканируется автоматически" />

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Модель / размер</label>
        <input id="model" placeholder="Nexen 195/65 R16" />
      </div>
      <div>
        <label>Локация</label>
        <input id="loc" placeholder="216" />
      </div>
    </div>

    <label style="margin-top:10px;">Кол-во</label>
    <input id="qty" type="number" placeholder="34" />

    <button id="save" class="primary" style="margin-top:12px;">
      Сохранить
    </button>
  </section>

  <!-- СПИСОК -->
  <section class="card">
    <div id="list"></div>
  </section>

</main>

<script>
/* ===== ХРАНЕНИЕ ===== */
const KEY = "tires_db";
let db = JSON.parse(localStorage.getItem(KEY) || "[]");

function saveDB() {
  localStorage.setItem(KEY, JSON.stringify(db));
  render();
}

/* ===== UI ===== */
const barcode = document.getElementById("barcode");
const model = document.getElementById("model");
const loc = document.getElementById("loc");
const qty = document.getElementById("qty");
const list = document.getElementById("list");
const status = document.getElementById("status");

document.getElementById("save").onclick = () => {
  if (!barcode.value) return alert("Нет штрих-кода");

  const i = db.findIndex(x => x.barcode === barcode.value);
  const item = {
    barcode: barcode.value,
    model: model.value,
    loc: loc.value,
    qty: Number(qty.value || 0),
    time: Date.now()
  };

  if (i >= 0) db[i] = item;
  else db.push(item);

  saveDB();
};

/* ===== СКАНЕР (html5-qrcode) ===== */
let scanner = null;
let last = "";

document.getElementById("start").onclick = async () => {
  if (!window.isSecureContext) {
    alert("Нужно HTTPS (GitHub Pages)");
    return;
  }

  scanner = new Html5Qrcode("reader");
  status.textContent = "Камера включена, наведи на штрих-код";

  document.getElementById("start").disabled = true;
  document.getElementById("stop").disabled = false;

  await scanner.start(
    { facingMode: "environment" },
    {
      fps: 12,
      qrbox: { width: 250, height: 150 },
      experimentalFeatures: {
        useBarCodeDetectorIfSupported: false
      }
    },
    (text) => {
      if (text === last) return;
      last = text;
      barcode.value = text;
      status.textContent = "Найдено: " + text;
    }
  );
};

document.getElementById("stop").onclick = async () => {
  if (scanner) {
    await scanner.stop();
    await scanner.clear();
  }
  document.getElementById("start").disabled = false;
  document.getElementById("stop").disabled = true;
  status.textContent = "Камера выключена";
};

/* ===== РЕНДЕР ===== */
function render() {
  list.innerHTML = "";
  db.forEach(i => {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <b>${i.model || "—"}</b><br>
      <span class="mono">${i.barcode}</span><br>
      Локация: ${i.loc || "-"} | Кол-во: ${i.qty}
    `;
    list.appendChild(d);
  });
}
render();
</script>
</body>
</html>
