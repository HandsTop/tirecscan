<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Шины — учет (сканер)</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0c10; color: #e6e6e6; }
    header { padding: 14px 16px; position: sticky; top: 0; background: rgba(11,12,16,.9); backdrop-filter: blur(10px); border-bottom: 1px solid #222; }
    header h1 { margin: 0; font-size: 16px; font-weight: 650; }
    main { padding: 14px 16px 24px; display: grid; gap: 14px; }
    .card { background: #12141a; border: 1px solid #23262f; border-radius: 14px; padding: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
    input, textarea, select {
      width: 100%; box-sizing: border-box;
      background: #0e1016; color: #e6e6e6;
      border: 1px solid #2a2f3a; border-radius: 10px;
      padding: 11px 12px; font-size: 16px;
      outline: none;
    }
    input:focus, textarea:focus { border-color: #4a78ff; }
    textarea { min-height: 44px; resize: vertical; }
    .btns { display:flex; flex-wrap: wrap; gap: 10px; }
    button {
      border: 1px solid #2a2f3a; background: #0e1016; color: #e6e6e6;
      padding: 10px 12px; border-radius: 12px; font-size: 15px;
    }
    button.primary { background: #1b3cff; border-color: #1b3cff; }
    button.danger { background: #2a0f14; border-color: #6b1a2b; color: #ffd7de; }
    button:disabled { opacity:.5; }
    .muted { font-size: 12px; opacity: .75; line-height: 1.35; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background: #0e1016; border: 1px solid #2a2f3a; font-size: 12px; }
    .videoWrap { display:grid; gap: 10px; }
    video { width: 100%; border-radius: 14px; background: #000; border: 1px solid #23262f; }
    .list { display:grid; gap: 10px; }
    .item { border: 1px solid #23262f; border-radius: 14px; padding: 12px; background: #0e1016; }
    .itemTop { display:flex; justify-content: space-between; gap: 10px; align-items: start; }
    .itemTitle { font-weight: 650; }
    .kv { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .kv span { font-size: 12px; opacity:.9; }
    .hr { height: 1px; background: #23262f; margin: 12px 0; }
    .small { font-size: 13px; opacity:.9; line-height: 1.35; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>

<body>
  <header>
    <h1>Шины — учет (камера + штрих-код)</h1>
  </header>

  <main>
    <section class="card">
      <div class="videoWrap">
        <div class="btns">
          <button id="btnStart" class="primary">Включить камеру</button>
          <button id="btnStop" disabled>Выключить камеру</button>
          <button id="btnScanOnce" disabled>Сканировать 1 раз</button>
        </div>

        <video id="video" playsinline muted></video>

        <div class="muted">
          <span class="pill" id="status">Статус: камера выключена</span>
          <div style="margin-top:8px">
            ⚠️ На iPhone сканирование камерой обычно работает только если страница открыта по <b>HTTPS</b>.
            Если открыть этот файл как “локальный документ”, камера может не запуститься.
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div>
          <label>Штрих-код</label>
          <input id="barcode" inputmode="numeric" placeholder="например 8807622204852" />
        </div>
        <div>
          <label>Кол-во</label>
          <input id="qty" inputmode="numeric" placeholder="например 34" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Модель / размер</label>
          <input id="model" placeholder="например Nexen 195/65 R16 104/102T" />
        </div>
        <div>
          <label>Где находится (локация)</label>
          <input id="loc" placeholder="например 216" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Комментарий (необязательно)</label>
        <textarea id="note" placeholder="любые пометки"></textarea>
      </div>

      <div class="btns" style="margin-top:12px">
        <button id="btnAdd" class="primary">Добавить / обновить по штрих-коду</button>
        <button id="btnClear">Очистить поля</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Логика: если такой штрих-код уже есть — запись обновится (модель/локация/кол-во/комментарий).
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div>
          <label>Поиск</label>
          <input id="search" placeholder="ищет по модели, локации, штрих-коду" />
        </div>
        <div>
          <label>Сортировка</label>
          <select id="sort">
            <option value="updated_desc">Сначала новые</option>
            <option value="updated_asc">Сначала старые</option>
            <option value="model_asc">Модель A→Z</option>
            <option value="loc_asc">Локация A→Z</option>
            <option value="qty_desc">Кол-во ↓</option>
          </select>
        </div>
      </div>

      <div class="btns" style="margin-top:12px">
        <button id="btnExportJson">Экспорт JSON</button>
        <button id="btnImportJson">Импорт JSON</button>
        <button id="btnExportCsv">Экспорт CSV</button>
        <button id="btnWipe" class="danger">Удалить ВСЕ данные</button>
      </div>

      <input id="fileInput" type="file" accept="application/json" style="display:none" />

      <div class="hr"></div>
      <div class="small" id="stats">Записей: 0</div>
      <div class="list" id="list"></div>
    </section>
  </main>

<script>
(() => {
  // ===== Storage =====
  const KEY = "tires_inventory_v1";

  /** @type {Array<{barcode:string, model:string, loc:string, qty:number, note:string, createdAt:number, updatedAt:number}>} */
  let db = load();

  function load() {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function save() {
    localStorage.setItem(KEY, JSON.stringify(db));
  }

  // ===== UI elements =====
  const $ = (id) => document.getElementById(id);

  const video = $("video");
  const status = $("status");

  const barcode = $("barcode");
  const model = $("model");
  const loc = $("loc");
  const qty = $("qty");
  const note = $("note");

  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnScanOnce = $("btnScanOnce");

  const btnAdd = $("btnAdd");
  const btnClear = $("btnClear");

  const search = $("search");
  const sort = $("sort");
  const list = $("list");
  const stats = $("stats");

  const btnExportJson = $("btnExportJson");
  const btnImportJson = $("btnImportJson");
  const btnExportCsv = $("btnExportCsv");
  const btnWipe = $("btnWipe");
  const fileInput = $("fileInput");

  // ===== Camera / scanning =====
  let stream = null;
  let detector = null;
  let scanning = false;
  let lastHit = { value: "", ts: 0 };

  function setStatus(text) { status.textContent = "Статус: " + text; }

  function isSecureEnough() {
    // getUserMedia requires secure context (https) on iOS Safari (обычно).
    return window.isSecureContext;
  }

  async function startCamera() {
    if (!navigator.mediaDevices?.getUserMedia) {
      alert("Этот браузер не поддерживает доступ к камере через getUserMedia.");
      return;
    }
    if (!isSecureEnough()) {
      alert("Для камеры нужен HTTPS. Открой эту страницу по https-ссылке (не как локальный файл).");
      return;
    }

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();

      // BarcodeDetector (если доступен)
      if ("BarcodeDetector" in window) {
        const formats = ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf","qr_code"];
        detector = new BarcodeDetector({ formats });
        setStatus("камера включена, BarcodeDetector активен");
        btnScanOnce.disabled = false;
      } else {
        detector = null;
        setStatus("камера включена, но BarcodeDetector недоступен (нужен iOS/Safari новее)");
        btnScanOnce.disabled = true;
        alert("BarcodeDetector недоступен в этом Safari. Можно вносить штрих-коды вручную.");
      }

      btnStart.disabled = true;
      btnStop.disabled = false;
    } catch (e) {
      console.error(e);
      alert("Не удалось включить камеру. Проверь разрешения Safari → Камера.");
    }
  }

  function stopCamera() {
    scanning = false;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    detector = null;

    btnStart.disabled = false;
    btnStop.disabled = true;
    btnScanOnce.disabled = true;
    setStatus("камера выключена");
  }

  async function scanOnce() {
    if (!detector || !stream) return;

    try {
      // На iOS иногда нужно дождаться готового кадра
      if (video.readyState < 2) {
        await new Promise(r => setTimeout(r, 200));
      }

      const results = await detector.detect(video);
      if (!results || results.length === 0) {
        setStatus("не найден штрих-код (попробуй ближе/ровнее/свет)");
        return;
      }

      // Берем первый результат
      const value = (results[0].rawValue || "").trim();
      if (!value) return;

      // Защита от дребезга
      const now = Date.now();
      if (value === lastHit.value && (now - lastHit.ts) < 1500) return;
      lastHit = { value, ts: now };

      barcode.value = value;
      setStatus("найден: " + value);
      // удобно перейти к вводу остальных полей
      model.focus();
    } catch (e) {
      console.error(e);
      setStatus("ошибка сканирования");
    }
  }

  // ===== CRUD =====
  function normalizeBarcode(s) {
    return (s || "").replace(/\s+/g, "").trim();
  }

  function upsert() {
    const bc = normalizeBarcode(barcode.value);
    if (!bc) { alert("Введи штрих-код."); return; }

    const q = Number(String(qty.value).replace(",", "."));
    if (!Number.isFinite(q) || q < 0) { alert("Кол-во должно быть числом (0 или больше)."); return; }

    const m = (model.value || "").trim();
    const l = (loc.value || "").trim();
    const n = (note.value || "").trim();

    const now = Date.now();
    const idx = db.findIndex(x => x.barcode === bc);

    if (idx >= 0) {
      db[idx] = { ...db[idx], model: m, loc: l, qty: q, note: n, updatedAt: now };
    } else {
      db.push({ barcode: bc, model: m, loc: l, qty: q, note: n, createdAt: now, updatedAt: now });
    }

    save();
    render();
    setStatus("сохранено: " + bc);
  }

  function fillForm(item) {
    barcode.value = item.barcode;
    model.value = item.model || "";
    loc.value = item.loc || "";
    qty.value = String(item.qty ?? "");
    note.value = item.note || "";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function remove(barcodeValue) {
    const bc = normalizeBarcode(barcodeValue);
    db = db.filter(x => x.barcode !== bc);
    save();
    render();
  }

  function clearForm() {
    barcode.value = "";
    model.value = "";
    loc.value = "";
    qty.value = "";
    note.value = "";
    barcode.focus();
  }

  // ===== Export/Import =====
  function download(filename, text, mime="text/plain") {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  function exportJson() {
    const payload = JSON.stringify({ version: 1, exportedAt: new Date().toISOString(), items: db }, null, 2);
    download("tires-inventory.json", payload, "application/json");
  }

  function importJson() {
    fileInput.value = "";
    fileInput.click();
  }

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      const items = Array.isArray(parsed) ? parsed : parsed.items;
      if (!Array.isArray(items)) throw new Error("Bad format");

      // минимальная валидация + merge по barcode
      const map = new Map(db.map(x => [x.barcode, x]));
      for (const it of items) {
        const bc = normalizeBarcode(it.barcode);
        if (!bc) continue;
        const now = Date.now();
        const merged = {
          barcode: bc,
          model: (it.model || "").trim(),
          loc: (it.loc || "").trim(),
          qty: Number(it.qty ?? 0),
          note: (it.note || "").trim(),
          createdAt: Number(it.createdAt ?? now),
          updatedAt: Number(it.updatedAt ?? now),
        };
        map.set(bc, merged);
      }
      db = Array.from(map.values());
      save();
      render();
      alert("Импорт завершен.");
    } catch (e) {
      console.error(e);
      alert("Не удалось импортировать JSON.");
    }
  });

  function exportCsv() {
    const esc = (s) => `"${String(s ?? "").replaceAll('"','""')}"`;
    const rows = [
      ["barcode","model","loc","qty","note","createdAt","updatedAt"].map(esc).join(",")
    ];
    for (const x of db) {
      rows.push([
        x.barcode, x.model, x.loc, x.qty, x.note,
        new Date(x.createdAt).toISOString(),
        new Date(x.updatedAt).toISOString()
      ].map(esc).join(","));
    }
    download("tires-inventory.csv", rows.join("\n"), "text/csv");
  }

  function wipeAll() {
    if (!confirm("Точно удалить ВСЕ данные?")) return;
    db = [];
    save();
    render();
  }

  // ===== Render =====
  function compare(a, b, mode) {
    if (mode === "updated_desc") return (b.updatedAt||0) - (a.updatedAt||0);
    if (mode === "updated_asc") return (a.updatedAt||0) - (b.updatedAt||0);
    if (mode === "model_asc") return String(a.model||"").localeCompare(String(b.model||""), "ru");
    if (mode === "loc_asc") return String(a.loc||"").localeCompare(String(b.loc||""), "ru");
    if (mode === "qty_desc") return (b.qty||0) - (a.qty||0);
    return 0;
  }

  function render() {
    const q = (search.value || "").trim().toLowerCase();
    const mode = sort.value;

    let items = db.slice();
    if (q) {
      items = items.filter(x =>
        String(x.barcode||"").toLowerCase().includes(q) ||
        String(x.model||"").toLowerCase().includes(q) ||
        String(x.loc||"").toLowerCase().includes(q) ||
        String(x.note||"").toLowerCase().includes(q)
      );
    }
    items.sort((a,b) => compare(a,b,mode));

    stats.textContent = `Записей: ${db.length}` + (q ? ` (показано: ${items.length})` : "");

    list.innerHTML = "";
    if (items.length === 0) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "Пока нет записей. Отсканируй штрих-код или введи вручную и нажми «Добавить»";
      list.appendChild(empty);
      return;
    }

    for (const it of items) {
      const el = document.createElement("div");
      el.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "itemTitle";
      title.textContent = it.model || "(без модели)";
      const bc = document.createElement("div");
      bc.className = "small mono";
      bc.textContent = it.barcode;
      left.appendChild(title);
      left.appendChild(bc);

      const right = document.createElement("div");
      right.style.display = "grid";
      right.style.gap = "8px";
      right.style.justifyItems = "end";

      const btnEdit = document.createElement("button");
      btnEdit.textContent = "Открыть";
      btnEdit.onclick = () => fillForm(it);

      const btnDel = document.createElement("button");
      btnDel.className = "danger";
      btnDel.textContent = "Удалить";
      btnDel.onclick = () => {
        if (confirm("Удалить запись?")) remove(it.barcode);
      };

      right.appendChild(btnEdit);
      right.appendChild(btnDel);

      top.appendChild(left);
      top.appendChild(right);

      const kv = document.createElement("div");
      kv.className = "kv";
      kv.innerHTML = `
        <span class="pill">Локация: <b>${(it.loc || "-")}</b></span>
        <span class="pill">Кол-во: <b>${Number.isFinite(it.qty) ? it.qty : "-"}</b></span>
        <span class="pill">Обновлено: <b>${new Date(it.updatedAt).toLocaleString()}</b></span>
      `;

      const noteEl = document.createElement("div");
      noteEl.className = "small";
      noteEl.style.marginTop = "8px";
      noteEl.textContent = it.note ? `Комментарий: ${it.note}` : "";

      el.appendChild(top);
      el.appendChild(kv);
      if (it.note) el.appendChild(noteEl);

      list.appendChild(el);
    }
  }

  // ===== Events =====
  btnStart.addEventListener("click", startCamera);
  btnStop.addEventListener("click", stopCamera);
  btnScanOnce.addEventListener("click", scanOnce);

  btnAdd.addEventListener("click", upsert);
  btnClear.addEventListener("click", clearForm);

  search.addEventListener("input", render);
  sort.addEventListener("change", render);

  btnExportJson.addEventListener("click", exportJson);
  btnImportJson.addEventListener("click", importJson);
  btnExportCsv.addEventListener("click", exportCsv);
  btnWipe.addEventListener("click", wipeAll);

  // Автоподсказка: если вставили штрих-код, сразу в поле кол-ва
  barcode.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); qty.focus(); }
  });

  // Initial render
  render();
})();
</script>
</body>
</html>
